#! /usr/bin/python

import json, datetime, random, os, sys


def main():
    path = os.environ['HOME'] + '/.WELCOME'

    now = datetime.date.today()

    # %host -> host, %user -> username, %date -> date
    welcome = json.loads(open(path, 'r').read().replace('%host', os.uname().nodename).replace('%user', os.environ['LOGNAME']).replace('%date', now.strftime('%A, %d %b %Y')))
    
    rows, columns = os.popen('stty size', 'r').read().split()
    width = min(welcome['width_max'], int(columns)) - 2
    if width < welcome['width_min']:
        sys.exit()

    box_ansi = parseansi(welcome['ansi'])
    
    printout = box_ansi + '┏' + '━' * width + '┓' + '\n'
    separator = box_ansi + '┠' + '─' * width + '┨\n'

    for notif in welcome['notifications']:
        tipe = notif['type']
        output = None
        tick = True
        if tipe == 'random':
            output = rand(notif, now)
        elif tipe == 'splash':
            output = splash(notif, now)
        elif tipe == 'reminder':
            output = reminder(notif, now)
        elif tipe == 'always':
            output = always(notif, now)
        elif tipe == 'header':
            output = notif['header']
            tick = False
        elif tipe == 'separator':
            printout += separator
        elif tipe == 'weekly':
            output = weekly(notif, now)
        if output is not None:
            if 'msg' in notif:
                output = notif['msg'].replace('%s', output)
            if 'ansi' in notif:
                printout += pad(output, width, box_ansi, tick=tick, ansi=parseansi(notif['ansi']))
            else:
                printout += pad(output, width, box_ansi, tick=tick)

    printout += box_ansi + '┗' + '━' * width + '┛'
    print(printout)

def pad(message, width, box_ansi, tick=False, ansi=''):
    plain = '\33[0m'
    s = 0
    n = width - 2
    for i in range(len(message)):
        if message[i] == ' ' or message[i] == '\n':
            s = i
        if i == n:
            message = message[:s] + '\n' + message[s+1:]
            n = s + width - 2
    msg = message.split('\n')
    output = ''
    for m in msg:
        output += '┃ ' + ansi + m + ' ' *(width - len(m) - 1) + box_ansi + '┃\n'
    if tick:
        output = '┣' + output[1:]
    return output

def parseansi(ansi):
    esc = '\33['
    out = ''
    if 'r' in ansi and 'g' in ansi and 'b' in ansi:
        out = '\33[38;2;' + str(ansi['r']) + ';' + str(ansi['g']) + ';' + str(ansi['b']) + 'm'
    if 'codes' in ansi:
        for code in ansi['codes']:
            out += esc + str(code) + 'm'
    return "\33[0m" + out

def reminder(notif, now):
    warnings = notif['warnings']
    strp = notif['strp']
    values = notif['values']
    returns = ''
    for val in values:
        t = datetime.datetime.strptime(val, strp).date()
        t = t.replace(year=now.year)
        if t < now:
            t = t.replace(year=t.year+1)
        delta = t - now
        if delta.days in warnings:
            returns += values[val] + '\n'
    if returns == '':
        return
    return returns.strip()

def rand(notif, now):
    random.seed(str(now) + notif['name'])
    if random.random() > notif['null_chance']:
        return random.choice(notif['values'])

def splash(notif, now):
    random.seed()
    if random.random() > notif['null_chance']:
        return random.choice(notif['values'])

def always(notif, now):
    out = ''
    for v in notif['values']:
        out += v + '\n'
    return out.strip()

def weekly(notif, now):
    values = notif['values']
    strp = notif['strp']
    for val in values:
        t = now.strftime(strp)
        if t == val:
            return values[val]
    

if __name__ == '__main__':
    main()
